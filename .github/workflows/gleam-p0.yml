name: Gleam p0 CI

on:
  push:
    paths:
      - "gleam/p0/**"
  pull_request:
    paths:
      - "gleam/p0/**"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Gleam
        uses: erlef/setup-beam@v1
        with:
          otp-version: "27.1"
          gleam-version: "1.13.0"

      - name: Download dependencies
        working-directory: gleam/p0
        run: |
          echo "ðŸ“¦ Downloading dependencies..."
          gleam deps download

      - name: Check formatting
        working-directory: gleam/p0
        run: |
          echo "ðŸŽ¨ Checking code formatting..."
          gleam format --check src test
          echo "âœ… Code formatting is correct"

      - name: Build project
        working-directory: gleam/p0
        run: |
          echo "ðŸ”¨ Building project..."
          gleam build
          echo "âœ… Build successful"

      - name: Run all tests with detailed output
        working-directory: gleam/p0
        shell: bash
        run: |
          set -euo pipefail
          echo "========================================="
          echo "Running Gleam Tests"
          echo "========================================="
          echo ""

          # Run tests and capture output
          if gleam test 2>&1 | tee test_output.txt; then
            TEST_STATUS="âœ… PASSED"
            TEST_RESULT="success"
          else
            TEST_STATUS="âŒ FAILED"
            TEST_RESULT="failure"
          fi

          # Count test results
          PASSED=$(grep -c "passed" test_output.txt || echo "0")
          FAILED=$(grep -c "failures" test_output.txt || echo "0")

          echo ""
          echo "========================================="
          echo "Test Summary: $TEST_STATUS"
          echo "========================================="

          # Create formatted summary for GitHub
          {
            echo "## ðŸ§ª Gleam p0 Test Results"
            echo ""
            echo "**Status:** $TEST_STATUS"
            echo ""
            echo "| Metric | Value |"
            echo "|--------|-------|"
            echo "| Tests Passed | $PASSED |"
            if [ "$FAILED" != "0" ]; then
              echo "| Tests Failed | $FAILED |"
            fi
            echo ""
            echo "### Full Test Output"
            echo ""
            echo '```'
            cat test_output.txt
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

          # Exit with appropriate code
          if [ "$TEST_RESULT" = "failure" ]; then
            exit 1
          fi

      - name: Run application and capture output
        working-directory: gleam/p0
        shell: bash
        run: |
          set -euo pipefail
          echo ""
          echo "========================================="
          echo "Running Gleam Application"
          echo "========================================="
          echo ""

          gleam run | tee script_output.txt

          echo ""
          echo "========================================="
          echo "Application completed successfully"
          echo "========================================="

          # Add to GitHub summary
          {
            echo ""
            echo "## ðŸš€ Gleam p0 Application Output"
            echo ""
            echo '```'
            cat script_output.txt
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"
