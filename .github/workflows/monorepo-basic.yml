name: Monorepo Common CI

on:
  push:
  pull_request:

jobs:
  repo-overview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ensure history available for diffs

      - name: Summarize changed files
        shell: bash
        run: |
          set -euo pipefail
          echo "Event: $GITHUB_EVENT_NAME"
          if [[ "$GITHUB_EVENT_NAME" == "pull_request" ]]; then
            BASE_REF="${{ github.event.pull_request.base.ref }}"
            echo "Base ref: $BASE_REF"
            # Fetch base branch ref and compare merge-base (triple-dot)
            git fetch --no-tags origin "$BASE_REF":"refs/remotes/origin/$BASE_REF"
            git diff --name-only "origin/$BASE_REF"...HEAD | sed 's/^/- /' || echo "No differences detected"
          else
            BEFORE="${{ github.event.before }}"
            AFTER="${{ github.sha }}"
            echo "Before: $BEFORE"
            echo "After:  $AFTER"
            if [[ "$BEFORE" == "0000000000000000000000000000000000000000" || -z "$BEFORE" ]]; then
              echo "Initial commit; listing all tracked files"
              git ls-files | sed 's/^/- /'
            else
              git diff --name-only "$BEFORE" "$AFTER" | sed 's/^/- /' || echo "No differences detected"
            fi
          fi

      - name: List modules present
        run: |
          echo "Modules detected:"
          for m in gleam java llm-rag python rust scala unison zig; do
            if [ -d "$m" ]; then
              echo "- $m"
            fi
          done

      - name: Disk usage by top-level dirs
        run: du -h --max-depth=1 | sort -h