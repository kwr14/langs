name: Monorepo Common CI

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  repo-overview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ensure history available for diffs

      - name: Summarize changed files
        shell: bash
        run: |
          # Be resilient to missing refs or shallow history
          set -u
          echo "Event: $GITHUB_EVENT_NAME"
          if [[ "$GITHUB_EVENT_NAME" == "pull_request" ]]; then
            BASE_REF="${{ github.event.pull_request.base.ref }}"
            echo "Base ref: $BASE_REF"
            # Try to fetch base branch; don't fail if unavailable
            git fetch --no-tags origin "$BASE_REF":"refs/remotes/origin/$BASE_REF" || true
            if git rev-parse --verify "refs/remotes/origin/$BASE_REF" >/dev/null 2>&1; then
              git diff --name-only "refs/remotes/origin/$BASE_REF"...HEAD | sed 's/^/- /' || true
            else
              echo "Base ref not available; listing files changed in HEAD"
              git show --name-only --pretty="" HEAD | sed 's/^/- /' || true
            fi
          else
            BEFORE="${{ github.event.before }}"
            AFTER="${{ github.sha }}"
            echo "Before: $BEFORE"
            echo "After:  $AFTER"
            if [[ "$BEFORE" == "0000000000000000000000000000000000000000" || -z "$BEFORE" ]]; then
              echo "Initial commit; listing all tracked files"
              git ls-files | sed 's/^/- /' || true
            elif git rev-parse --verify "$BEFORE" >/dev/null 2>&1; then
              git diff --name-only "$BEFORE" "$AFTER" | sed 's/^/- /' || true
            else
              echo "Previous SHA not present; listing files changed in HEAD"
              git show --name-only --pretty="" HEAD | sed 's/^/- /' || true
            fi
          fi

      - name: List modules present
        run: |
          echo "Modules detected:"
          for m in gleam java llm-rag python rust scala unison zig; do
            if [ -d "$m" ]; then
              echo "- $m"
            fi
          done

      - name: Disk usage by top-level dirs
        run: du -h --max-depth=1 | sort -h