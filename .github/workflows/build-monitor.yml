name: CI Build Monitor

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *" # hourly

permissions:
  contents: read
  actions: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate CI status markdown
        id: gen
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // List all workflows in the repo
            const { data: workflowsData } = await github.rest.actions.listRepoWorkflows({ owner, repo, per_page: 100 });
            const workflows = (workflowsData.workflows || [])
              .filter(w => !!w.name)
              .sort((a, b) => a.name.localeCompare(b.name));

            const tableRows = [];

            for (const w of workflows) {
              // Get the latest run for each workflow
              const { data: runsData } = await github.rest.actions.listWorkflowRuns({ owner, repo, workflow_id: w.id, per_page: 1 });
              const run = (runsData.workflow_runs || [])[0];

              const status = run?.status || 'n/a';
              const conclusion = run?.conclusion || 'n/a';
              const event = run?.event || 'n/a';
              const sha = run?.head_sha ? run.head_sha.substring(0, 7) : 'n/a';
              const fullSha = run?.head_sha || 'n/a';
              const branch = run?.head_branch || 'n/a';
              const url = run?.html_url || w.html_url;
              const started = run?.run_started_at || run?.created_at || null;
              const completed = run?.completed_at || run?.updated_at || null;
              const lastRun = completed || started || null;
              let lastRunDisplay = 'n/a';
              if (lastRun) {
                try {
                  const date = new Date(lastRun);
                  // Format as: Nov 14, 22:53
                  const month = date.toLocaleString('en-US', { month: 'short' });
                  const day = date.getDate();
                  const hours = String(date.getHours()).padStart(2, '0');
                  const minutes = String(date.getMinutes()).padStart(2, '0');
                  lastRunDisplay = `${month} ${day}, ${hours}:${minutes}`;
                } catch { lastRunDisplay = String(lastRun); }
              }

              const emojiMap = { success: '‚úÖ', failure: '‚ùå', cancelled: 'üö´', neutral: '‚ñ´Ô∏è', timed_out: '‚è±Ô∏è', action_required: 'üü°', skipped: '‚§¥Ô∏è' };
              const emoji = emojiMap[conclusion] || '‚ùì';

              // Build smart URL column with embedded collapsible details for failures
              let smartUrl;
              if (conclusion === 'failure' || conclusion === 'timed_out') {
                // Fetch commit and job details for failures
                let author = 'Unknown';
                let commitMessage = '';
                let commitUrl = '';

                if (fullSha !== 'n/a') {
                  try {
                    const { data: commit } = await github.rest.repos.getCommit({ owner, repo, ref: fullSha });
                    author = commit.commit.author.name;
                    commitMessage = commit.commit.message.split('\n')[0]; // First line only
                    commitUrl = commit.html_url;
                  } catch (e) {
                    console.log(`Could not fetch commit info for ${fullSha}: ${e.message}`);
                  }
                }

                // Get failed jobs
                let failedJobs = [];
                if (run?.id) {
                  try {
                    const { data: jobsData } = await github.rest.actions.listJobsForWorkflowRun({ owner, repo, run_id: run.id });
                    failedJobs = (jobsData.jobs || [])
                      .filter(j => j.conclusion === 'failure' || j.conclusion === 'timed_out')
                      .map(j => ({ name: j.name, url: j.html_url, conclusion: j.conclusion }));
                  } catch (e) {
                    console.log(`Could not fetch jobs for run ${run.id}: ${e.message}`);
                  }
                }

                // Create issue link with pre-filled details
                const issueTitle = encodeURIComponent(`CI Failure: ${w.name} on ${branch}`);
                const issueBody = encodeURIComponent(
                  `## CI Build Failure\n\n` +
                  `**Workflow:** ${w.name}\n` +
                  `**Branch:** ${branch}\n` +
                  `**Commit:** ${sha} - ${commitMessage}\n` +
                  `**Author:** @${author}\n` +
                  `**Run:** ${url}\n\n` +
                  `### Failed Jobs\n` +
                  (failedJobs.length ? failedJobs.map(j => `- [${j.name}](${j.url}) - ${j.conclusion}`).join('\n') : 'No job details available') +
                  `\n\n### Action Required\n` +
                  `Please investigate and fix the failing build.\n`
                );
                const createIssueUrl = `https://github.com/${owner}/${repo}/issues/new?title=${issueTitle}&body=${issueBody}&assignees=${author}`;

                // Build collapsible details in URL column
                const failedJobsList = failedJobs.map(j => `[${j.name}](${j.url})`).join(', ') || 'N/A';
                const assignLink = `<a href="${createIssueUrl}">üë§ Assign to Author</a>`;
                smartUrl = `<details><summary>‚¨áÔ∏è Details</summary><br/><br/>üìù [\`${sha}\`](${commitUrl})<br/>üë§ ${author}<br/>‚ùå ${failedJobsList}<br/>‚ö° ${assignLink}</details>`;
              } else {
                // For successful builds, just show a link
                smartUrl = `[View](${url})`;
              }

              // Main table row
              tableRows.push(`| ${w.name} | ${status} | ${emoji} ${conclusion} | ${event} | ${lastRunDisplay} | ${branch} | ${smartUrl} |`);
            }

            // Build the markdown content
            let content = `# CI Build Monitor\n\n`;
            content += `Last updated: ${new Date().toISOString()}\n\n`;

            // Summary section
            const totalWorkflows = workflows.length;
            const successCount = tableRows.filter(r => r.includes('‚úÖ')).length;
            const failureCount = tableRows.filter(r => r.includes('‚ùå')).length;
            const cancelledCount = tableRows.filter(r => r.includes('üö´')).length;
            const timedOutCount = tableRows.filter(r => r.includes('‚è±Ô∏è')).length;

            content += `## Summary\n\n`;
            content += `- **Total Workflows:** ${totalWorkflows}\n`;
            content += `- **‚úÖ Successful:** ${successCount}\n`;
            content += `- **‚ùå Failed:** ${failureCount}\n`;
            content += `- **üö´ Cancelled:** ${cancelledCount}\n`;
            content += `- **‚è±Ô∏è Timed Out:** ${timedOutCount}\n\n`;

            // All workflows table with inline collapsible details
            content += `## All Workflows\n\n`;
            content += `üí° *Failed workflows show ‚¨áÔ∏è Details - click to expand inline. Successful workflows show View link.*\n\n`;
            content += '| Workflow | Status | Conclusion | Event | Last Run | Branch | URL |\n';
            content += '|---|---|---|---|---|---|---|\n';
            content += tableRows.length ? tableRows.join('\n') + '\n' : '_No workflows found_\n';

            // Create HTML page for GitHub Pages
            const html = `<!DOCTYPE html>
            <html lang="en">
            <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <meta http-equiv="refresh" content="300">
              <title>CI Build Monitor - langs</title>
              <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.0/github-markdown.min.css">
              <style>
                body {
                  box-sizing: border-box;
                  min-width: 200px;
                  max-width: 980px;
                  margin: 0 auto;
                  padding: 45px;
                  background-color: #ffffff;
                }
                .markdown-body {
                  background-color: #ffffff;
                  color: #24292f;
                }
                .markdown-body table {
                  display: block;
                  width: max-content;
                  max-width: 100%;
                  overflow: auto;
                }
              </style>
            </head>
            <body>
              <article class="markdown-body">
                <div id="content"></div>
              </article>
              <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
              <script>
                const markdown = \`${content.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`;
                document.getElementById('content').innerHTML = marked.parse(markdown);
              </script>
            </body>
            </html>`;

            // Create _site directory for GitHub Pages
            const path = require('path');
            const siteDir = path.join(process.cwd(), '_site');
            if (!fs.existsSync(siteDir)) {
              fs.mkdirSync(siteDir, { recursive: true });
            }

            // Write HTML file
            fs.writeFileSync(path.join(siteDir, 'index.html'), html);

            // Also write the markdown for reference
            fs.writeFileSync(path.join(siteDir, 'CI_STATUS.md'), content);

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "_site"

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
