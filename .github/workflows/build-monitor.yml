name: CI Build Monitor

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *" # hourly

permissions:
  contents: write
  actions: read

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate CI status markdown
        id: gen
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // List all workflows in the repo
            const { data: workflowsData } = await github.rest.actions.listRepoWorkflows({ owner, repo, per_page: 100 });
            const workflows = (workflowsData.workflows || [])
              .filter(w => !!w.name)
              .sort((a, b) => a.name.localeCompare(b.name));

            const rows = [];
            for (const w of workflows) {
              // Get the latest run for each workflow
              const { data: runsData } = await github.rest.actions.listWorkflowRuns({ owner, repo, workflow_id: w.id, per_page: 1 });
              const run = (runsData.workflow_runs || [])[0];

              const status = run?.status || 'n/a';
              const conclusion = run?.conclusion || 'n/a';
              const event = run?.event || 'n/a';
              const sha = run?.head_sha ? run.head_sha.substring(0, 7) : 'n/a';
              const branch = run?.head_branch || 'n/a';
              const url = run?.html_url || w.html_url;
              const started = run?.run_started_at || run?.created_at || null;
              const completed = run?.completed_at || run?.updated_at || null;
              const lastRun = completed || started || null;
              let lastRunDisplay = 'n/a';
              if (lastRun) {
                try { lastRunDisplay = new Date(lastRun).toISOString(); } catch { lastRunDisplay = String(lastRun); }
              }

              let duration = 'n/a';
              if (started && completed) {
                const dSec = (new Date(completed) - new Date(started)) / 1000;
                const mins = Math.floor(dSec / 60);
                const secs = Math.floor(dSec % 60);
                duration = `${mins}m ${secs}s`;
              }

              const emojiMap = { success: '‚úÖ', failure: '‚ùå', cancelled: 'üö´', neutral: '‚ñ´Ô∏è', timed_out: '‚è±Ô∏è', action_required: 'üü°', skipped: '‚§¥Ô∏è' };
              const emoji = emojiMap[conclusion] || '‚ùì';

              rows.push(`| ${w.name} | ${status} | ${emoji} ${conclusion} | ${event} | ${lastRunDisplay} | ${sha} | ${branch} | ${duration} | [link](${url}) |`);
            }

            const header = `# CI Build Monitor\n\nLast updated: ${new Date().toISOString()}\n\n`;
            const tableHeader = '| Workflow | Status | Conclusion | Event | Last Run | SHA | Branch | Duration | URL |\n|---|---|---|---|---|---|---|---|---|\n';
            const body = rows.length ? rows.join('\n') + '\n' : '_No workflows found_\n';
            const content = header + tableHeader + body;

            fs.writeFileSync('CI_STATUS.md', content);

      - name: Commit CI_STATUS.md update
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "CI monitor: update CI_STATUS.md"
          file_pattern: "CI_STATUS.md"